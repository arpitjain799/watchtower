
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>watchtower &#8212; watchtower  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/guzzle.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">watchtower  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">watchtower</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../index.html" class="text-logo">watchtower</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">Docs</a></li>
              
                <li><a href="index.html">Module code</a></li>
              
              <li>watchtower</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <h1>Source code for watchtower</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">botocore</span>
<span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="kn">import</span> <span class="n">ClientError</span>

<span class="n">DEFAULT_LOG_STREAM_NAME</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{machine_name}</span><span class="s2">/</span><span class="si">{program_name}</span><span class="s2">/</span><span class="si">{logger_name}</span><span class="s2">/</span><span class="si">{process_id}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_json_serialize_default</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard &#39;default&#39; json serializer function.</span>

<span class="sd">    - Serializes datetime objects using their .isoformat() method.</span>

<span class="sd">    - Serializes all other objects using repr().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_boto_debug_filter</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># Filter debug log messages from botocore and its dependency, urllib3.</span>
    <span class="c1"># This is required to avoid message storms any time we send logs.</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;botocore&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;urllib3&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_boto_filter</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># Filter log messages from botocore and its dependency, urllib3.</span>
    <span class="c1"># This is required to avoid an infinite loop when shutting down.</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;botocore&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;urllib3&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="WatchtowerWarning"><a class="viewcode-back" href="../index.html#watchtower.WatchtowerWarning">[docs]</a><span class="k">class</span> <span class="nc">WatchtowerWarning</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
    <span class="s2">&quot;Default warning class for the watchtower module.&quot;</span></div>


<div class="viewcode-block" id="WatchtowerError"><a class="viewcode-back" href="../index.html#watchtower.WatchtowerError">[docs]</a><span class="k">class</span> <span class="nc">WatchtowerError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="s2">&quot;Default exception class for the watchtower module.&quot;</span></div>


<div class="viewcode-block" id="CloudWatchLogFormatter"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogFormatter">[docs]</a><span class="k">class</span> <span class="nc">CloudWatchLogFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log formatter for CloudWatch messages. Transforms logged message into a message compatible with the CloudWatch API.</span>
<span class="sd">    This is the default formatter for CloudWatchLogHandler.</span>

<span class="sd">    This log formatter is designed to accommodate structured log messages by correctly serializing them as JSON, which</span>
<span class="sd">    is automatically recognized, parsed, and indexed by CloudWatch Logs. To use this feature, pass a dictionary input</span>
<span class="sd">    to the logger instead of a plain string::</span>

<span class="sd">        logger = logging.getLogger(__name__)</span>
<span class="sd">        logger.addHandler(watchtower.CloudWatchLogHandler())</span>
<span class="sd">        logger.critical({&quot;request&quot;: &quot;hello&quot;, &quot;metadata&quot;: {&quot;size&quot;: 9000}})</span>

<span class="sd">    If the optional `add_log_record_attrs` attribute or keyword argument is set, it enables the forwarding of specified</span>
<span class="sd">    `LogRecord attributes &lt;https://docs.python.org/3/library/logging.html#logrecord-attributes&gt;`_ with the message.</span>
<span class="sd">    In this mode, if the message is not already a dictionary, it is converted to one with the original message under the</span>
<span class="sd">    `msg` key::</span>

<span class="sd">        logger = logging.getLogger(__name__)</span>
<span class="sd">        handler = watchtower.CloudWatchLogHandler()</span>
<span class="sd">        handler.formatter.add_log_record_attrs=[&quot;levelname&quot;, &quot;filename&quot;, &quot;process&quot;, &quot;thread&quot;]</span>
<span class="sd">        logger.addHandler(handler)</span>
<span class="sd">        logger.critical({&quot;request&quot;: &quot;hello&quot;, &quot;metadata&quot;: {&quot;size&quot;: 9000}})</span>

<span class="sd">    The resulting raw CloudWatch Logs event will look like this::</span>

<span class="sd">        {&quot;timestamp&quot;: 1636868049692,</span>
<span class="sd">         &quot;message&quot;: &#39;{&quot;request&quot;: &quot;hello&quot;,</span>
<span class="sd">                      &quot;metadata&quot;: {&quot;size&quot;: 9000},</span>
<span class="sd">                      &quot;levelname&quot;: &quot;CRITICAL&quot;,</span>
<span class="sd">                      &quot;filename&quot;: &quot;/path/to/app.py&quot;,</span>
<span class="sd">                      &quot;process&quot;: 74542,</span>
<span class="sd">                      &quot;thread&quot;: 4659336704}&#39;,</span>
<span class="sd">         &quot;ingestionTime&quot;: 1636868050028}</span>

<span class="sd">    This enables sending log message metadata as structured log data instead of relying on string formatting.</span>
<span class="sd">    See `LogRecord attributes &lt;https://docs.python.org/3/library/logging.html#logrecord-attributes&gt;`_ for the full list</span>
<span class="sd">    of available attributes.</span>

<span class="sd">    :param json_serialize_default:</span>
<span class="sd">        The &#39;default&#39; function to use when serializing dictionaries as JSON. See the</span>
<span class="sd">        `JSON module documentation &lt;https://docs.python.org/3/library/json.html#json.dump&gt;`_</span>
<span class="sd">        for more details about the &#39;default&#39; parameter. By default, watchtower uses a serializer that formats datetime</span>
<span class="sd">        objects into strings using the `datetime.isoformat()` method, and uses `repr()` to represent all other objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">add_log_record_attrs</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">json_serialize_default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_log_record_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_serialize_default</span> <span class="o">=</span> <span class="n">_json_serialize_default</span>
        <span class="k">if</span> <span class="n">json_serialize_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_serialize_default</span> <span class="o">=</span> <span class="n">json_serialize_default</span>
        <span class="k">if</span> <span class="n">add_log_record_attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_record_attrs</span> <span class="o">=</span> <span class="n">add_log_record_attrs</span>

<div class="viewcode-block" id="CloudWatchLogFormatter.format"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogFormatter.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_log_record_attrs</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">msg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">msg</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_log_record_attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">message</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_serialize_default</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CloudWatchLogHandler"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogHandler">[docs]</a><span class="k">class</span> <span class="nc">CloudWatchLogHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new CloudWatch log handler object. This is the main entry point to the functionality of the module. See</span>
<span class="sd">    the `CloudWatch Logs developer guide</span>
<span class="sd">    &lt;http://docs.aws.amazon.com/AmazonCloudWatch/latest/DeveloperGuide/WhatIsCloudWatchLogs.html&gt;`_ and the</span>
<span class="sd">    `Python logging module documentation &lt;https://docs.python.org/3/library/logging.html&gt;`_ for more information.</span>

<span class="sd">    :param log_group_name:</span>
<span class="sd">        Name of the CloudWatch log group to write logs to. By default, the name of this module is used.</span>
<span class="sd">    :param log_stream_name:</span>
<span class="sd">        Name of the CloudWatch log stream to write logs to. By default, a string containing the machine name, the</span>
<span class="sd">        program name, and the name of the logger that processed the message is used. Accepts the following format string</span>
<span class="sd">        parameters: {machine_name}, {program_name}, {logger_name}, {process_id}, {thread_name}, and {strftime:%m-%d-%y},</span>
<span class="sd">        where any strftime string can be used to include the current UTC datetime in the stream name. The strftime</span>
<span class="sd">        format string option can be used to sort logs into streams on an hourly, daily, or monthly basis.</span>
<span class="sd">    :param use_queues:</span>
<span class="sd">        If **True** (the default), logs will be queued on a per-stream basis and sent in batches. To manage the queues,</span>
<span class="sd">        a queue handler thread will be spawned. You can set this to False to make it easier to debug threading issues in</span>
<span class="sd">        your application. Setting this to False in production is not recommended, since it will cause performance issues</span>
<span class="sd">        due to the synchronous sending of one CloudWatch API request per log message.</span>
<span class="sd">    :param send_interval:</span>
<span class="sd">        Maximum time (in seconds, or a timedelta) to hold messages in queue before sending a batch.</span>
<span class="sd">    :param max_batch_size:</span>
<span class="sd">        Maximum size (in bytes) of the queue before sending a batch. From CloudWatch Logs documentation: *The maximum</span>
<span class="sd">        batch size is 1,048,576 bytes, and this size is calculated as the sum of all event messages in UTF-8, plus 26</span>
<span class="sd">        bytes for each log event.*</span>
<span class="sd">    :param max_batch_count:</span>
<span class="sd">        Maximum number of messages in the queue before sending a batch. From CloudWatch Logs documentation: *The</span>
<span class="sd">        maximum number of log events in a batch is 10,000.*</span>
<span class="sd">    :param boto3_client:</span>
<span class="sd">        Client object for sending boto3 logs. Use this to pass custom session or client parameters. For example,</span>
<span class="sd">        to specify a custom region::</span>

<span class="sd">            CloudWatchLogHandler(boto3_client=boto3.client(&quot;logs&quot;, region_name=&quot;us-west-2&quot;))</span>

<span class="sd">        See the</span>
<span class="sd">        `boto3 session reference &lt;https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html&gt;`_</span>
<span class="sd">        for details about the available session and client options.</span>
<span class="sd">    :param boto3_profile_name:</span>
<span class="sd">        Name of the boto3 configuration profile to use. This option is provided for situations where the logger should</span>
<span class="sd">        use a different AWS client configuration from the rest of the system, but declarative configuration via a static</span>
<span class="sd">        dictionary or config file is desired.</span>
<span class="sd">    :param create_log_group:</span>
<span class="sd">        Create CloudWatch Logs log group if it does not exist.  **True** by default.</span>
<span class="sd">    :param log_group_retention_days:</span>
<span class="sd">        Sets the retention policy of the log group in days.  **None** by default.</span>
<span class="sd">    :param create_log_stream:</span>
<span class="sd">        Create CloudWatch Logs log stream if it does not exist.  **True** by default.</span>
<span class="sd">    :param json_serialize_default:</span>
<span class="sd">        The &#39;default&#39; function to use when serializing dictionaries as JSON. See the</span>
<span class="sd">        `JSON module documentation &lt;https://docs.python.org/3/library/json.html#json.dump&gt;`_</span>
<span class="sd">        for more details about the &#39;default&#39; parameter. By default, watchtower uses a serializer that formats datetime</span>
<span class="sd">        objects into strings using the `datetime.isoformat()` method, and uses `repr()` to represent all other objects.</span>
<span class="sd">    :param max_message_size:</span>
<span class="sd">        Maximum size (in bytes) of a single message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">END</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">FLUSH</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># extra size of meta information with each messages</span>
    <span class="n">EXTRA_MSG_PAYLOAD_SIZE</span> <span class="o">=</span> <span class="mi">26</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">log_group_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="vm">__name__</span><span class="p">,</span>
        <span class="n">log_stream_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_LOG_STREAM_NAME</span><span class="p">,</span>
        <span class="n">use_queues</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">send_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
        <span class="n">max_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="n">max_batch_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">boto3_client</span><span class="p">:</span> <span class="n">botocore</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">BaseClient</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boto3_profile_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_log_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">json_serialize_default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_group_retention_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_log_stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_message_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="n">log_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stream_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span> <span class="o">=</span> <span class="n">log_group_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_stream_name</span> <span class="o">=</span> <span class="n">log_stream_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_queues</span> <span class="o">=</span> <span class="n">use_queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_interval</span> <span class="o">=</span> <span class="n">send_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_serialize_default</span> <span class="o">=</span> <span class="n">json_serialize_default</span> <span class="ow">or</span> <span class="n">_json_serialize_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="o">=</span> <span class="n">max_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_count</span> <span class="o">=</span> <span class="n">max_batch_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_message_size</span> <span class="o">=</span> <span class="n">max_message_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_log_stream</span> <span class="o">=</span> <span class="n">create_log_stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_group_retention_days</span> <span class="o">=</span> <span class="n">log_group_retention_days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_state</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">log_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_group_name</span> <span class="o">!=</span> <span class="vm">__name__</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WatchtowerError</span><span class="p">(</span><span class="s2">&quot;Both log_group_name and deprecated log_group parameter specified&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Please use log_group_name instead of log_group&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span> <span class="o">=</span> <span class="n">log_group</span>
        <span class="k">if</span> <span class="n">stream_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_stream_name</span> <span class="o">!=</span> <span class="n">DEFAULT_LOG_STREAM_NAME</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WatchtowerError</span><span class="p">(</span><span class="s2">&quot;Both log_stream_name and deprecated stream_name parameter specified&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Please use log_stream_name instead of stream_name&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_stream_name</span> <span class="o">=</span> <span class="n">stream_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">CloudWatchLogFormatter</span><span class="p">(</span><span class="n">json_serialize_default</span><span class="o">=</span><span class="n">json_serialize_default</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">_boto_debug_filter</span><span class="p">)</span>

        <span class="c1"># Creating the client should be the final call in __init__, after all instance attributes are set.</span>
        <span class="c1"># This ensures that failing to create the session will not result in any missing attribtues.</span>
        <span class="k">if</span> <span class="n">boto3_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">boto3_profile_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">boto3_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">boto3_profile_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span> <span class="o">=</span> <span class="n">boto3_client</span>
        <span class="k">elif</span> <span class="n">boto3_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">boto3_profile_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">boto3_profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WatchtowerError</span><span class="p">(</span><span class="s2">&quot;Either boto3_client or boto3_profile_name can be specified, but not both&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_log_group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_log_group</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">log_group_retention_days</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idempotent_call</span><span class="p">(</span>
                <span class="s2">&quot;put_retention_policy&quot;</span><span class="p">,</span> <span class="n">logGroupName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="p">,</span> <span class="n">retentionInDays</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_retention_days</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_at_fork_reinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This was added in Python 3.9 and should only be called with a recent</span>
        <span class="c1"># version of Python. An older version will attempt to call createLock</span>
        <span class="c1"># instead.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_at_fork_reinit</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_tokens</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creating_log_stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutting_down</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_paginate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boto3_paginator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">boto3_paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">boto3_paginator</span><span class="o">.</span><span class="n">result_keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">result_key</span><span class="o">.</span><span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="p">[]):</span>
                    <span class="k">yield</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_ensure_log_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;describe_log_groups&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">log_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paginate</span><span class="p">(</span><span class="n">paginator</span><span class="p">,</span> <span class="n">logGroupNamePrefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">log_group</span><span class="p">[</span><span class="s2">&quot;logGroupName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="p">:</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idempotent_call</span><span class="p">(</span><span class="s2">&quot;create_log_group&quot;</span><span class="p">,</span> <span class="n">logGroupName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_idempotent_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">method_callable</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">method_callable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">OperationAbortedException</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceAlreadyExistsException</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">pass</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_machine_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_stream_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_stream_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">machine_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_machine_name</span><span class="p">(),</span>
            <span class="n">program_name</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">process_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
            <span class="n">thread_name</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">logger_name</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">strftime</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># Calculate the byte size of a message - accounting for unicode, and extra payload size</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="p">)</span> <span class="o">+</span> <span class="n">CloudWatchLogHandler</span><span class="o">.</span><span class="n">EXTRA_MSG_PAYLOAD_SIZE</span>

    <span class="k">def</span> <span class="nf">_truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">max_size</span><span class="p">):</span>
        <span class="c1"># Truncate oversized messages by bytes, and not string length</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Log message size exceeds CWL max payload size, truncated&quot;</span><span class="p">,</span> <span class="n">WatchtowerWarning</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)[:</span><span class="n">max_size</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">_submit_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">log_stream_name</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sorted_batch</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">logGroupName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="p">,</span> <span class="n">logStreamName</span><span class="o">=</span><span class="n">log_stream_name</span><span class="p">,</span> <span class="n">logEvents</span><span class="o">=</span><span class="n">sorted_batch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_tokens</span><span class="p">[</span><span class="n">log_stream_name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sequenceToken&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_tokens</span><span class="p">[</span><span class="n">log_stream_name</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">put_log_events</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">DataAlreadyAcceptedException</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidSequenceTokenException</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">):</span>
                    <span class="n">next_expected_token</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># null as the next sequenceToken means don&#39;t include any</span>
                    <span class="c1"># sequenceToken at all, not that the token should be set to &quot;null&quot;</span>
                    <span class="k">if</span> <span class="n">next_expected_token</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sequenceToken&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sequenceToken&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_expected_token</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwl_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceNotFoundException</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_log_stream</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">creating_log_stream</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_idempotent_call</span><span class="p">(</span>
                                <span class="s2">&quot;create_log_stream&quot;</span><span class="p">,</span> <span class="n">logGroupName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="p">,</span> <span class="n">logStreamName</span><span class="o">=</span><span class="n">log_stream_name</span>
                            <span class="p">)</span>
                            <span class="c1"># We now have a new stream name and the next retry</span>
                            <span class="c1"># will be the first attempt to log to it, so we</span>
                            <span class="c1"># should not continue to use the old sequence token</span>
                            <span class="c1"># at this point, the first write to the new stream</span>
                            <span class="c1"># should not contain a sequence token at all.</span>
                            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sequenceToken&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">creating_log_stream</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to deliver logs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">WatchtowerWarning</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to deliver logs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">WatchtowerWarning</span><span class="p">)</span>

        <span class="c1"># response can be None only when all retries have been exhausted</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;rejectedLogEventsInfo&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to deliver logs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">WatchtowerWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;nextSequenceToken&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="c1"># According to https://github.com/kislyuk/watchtower/issues/134, nextSequenceToken may sometimes be absent</span>
            <span class="c1"># from the response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence_tokens</span><span class="p">[</span><span class="n">log_stream_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;nextSequenceToken&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="CloudWatchLogHandler.createLock"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogHandler.createLock">[docs]</a>    <span class="k">def</span> <span class="nf">createLock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">createLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudWatchLogHandler.emit"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogHandler.emit">[docs]</a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creating_log_stream</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Avoid infinite recursion when asked to log a message as our own side effect</span>

        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">getMessage</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Received empty message. Empty messages cannot be sent to CloudWatch Logs&quot;</span><span class="p">,</span> <span class="n">WatchtowerWarning</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stream_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream_name</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stream_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_tokens</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sequence_tokens</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cwl_message</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">created</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

            <span class="n">max_message_body_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_message_size</span> <span class="o">-</span> <span class="n">CloudWatchLogHandler</span><span class="o">.</span><span class="n">EXTRA_MSG_PAYLOAD_SIZE</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">(</span><span class="n">cwl_message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_message_body_size</span><span class="p">:</span>
                <span class="n">cwl_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span><span class="p">(</span><span class="n">cwl_message</span><span class="p">,</span> <span class="n">max_message_body_size</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_queues</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stream_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                    <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dequeue_batch</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="n">stream_name</span><span class="p">],</span>
                            <span class="n">stream_name</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">send_interval</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_count</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutting_down</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Received message after logging system shutdown&quot;</span><span class="p">,</span> <span class="n">WatchtowerWarning</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cwl_message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_submit_batch</span><span class="p">([</span><span class="n">cwl_message</span><span class="p">],</span> <span class="n">stream_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_dequeue_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_queue</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">send_interval</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="p">,</span> <span class="n">max_batch_count</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># See https://boto3.readthedocs.io/en/latest/reference/services/logs.html#CloudWatchLogs.Client.put_log_events</span>
        <span class="k">while</span> <span class="n">msg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span><span class="p">:</span>
            <span class="n">cur_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">msg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLUSH</span> <span class="k">else</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
            <span class="n">cur_batch_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">,</span> <span class="n">cur_batch</span><span class="p">))</span>
            <span class="n">cur_batch_msg_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_batch</span><span class="p">)</span>
            <span class="n">cur_batch_deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">send_interval</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">my_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cur_batch_deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="c1"># If the queue is empty, we don&#39;t want to reprocess the previous message</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">or</span> <span class="n">msg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span>
                    <span class="ow">or</span> <span class="n">msg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLUSH</span>
                    <span class="ow">or</span> <span class="n">cur_batch_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_batch_size</span>
                    <span class="ow">or</span> <span class="n">cur_batch_msg_count</span> <span class="o">&gt;=</span> <span class="n">max_batch_count</span>
                    <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">cur_batch_deadline</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_submit_batch</span><span class="p">(</span><span class="n">cur_batch</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># We don&#39;t want to call task_done if the queue was empty and we didn&#39;t receive anything new</span>
                        <span class="n">my_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="n">cur_batch_size</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">cur_batch_msg_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cur_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">my_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

<div class="viewcode-block" id="CloudWatchLogHandler.flush"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogHandler.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send any queued messages to CloudWatch. This method does nothing if ``use_queues`` is set to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fixme: don&#39;t add filter if it&#39;s already installed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">_boto_filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutting_down</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLUSH</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudWatchLogHandler.close"><a class="viewcode-back" href="../index.html#watchtower.CloudWatchLogHandler.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send any queued messages to CloudWatch and prevent further processing of messages.</span>
<span class="sd">        This method does nothing if ``use_queues`` is set to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fixme: don&#39;t add filter if it&#39;s already installed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">_boto_filter</span><span class="p">)</span>
        <span class="c1"># Avoid waiting on the queue again when the close called twice.</span>
        <span class="c1"># Otherwise the second call, as no thread is running, it will hang</span>
        <span class="c1"># forever</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutting_down</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutting_down</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(log_group_name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_group_name</span><span class="si">}</span><span class="s2">&#39;, log_stream_name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_stream_name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span></div>
</pre></div>

          </div>
            
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">watchtower  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">watchtower</a></li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright Andrey Kislyuk. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>